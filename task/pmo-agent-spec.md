# PMOエージェント仕様書 v1.0

## 1. 概要

### 1.1 目的
Notion API・Google スプレッドシート・GitHub・LLM・Slack を連携し、プロジェクトのタスク進捗管理を自動化するAIエージェントを構築する。

### 1.2 解決する課題

| # | 課題 | 対応するフローステップ |
|---|------|----------------------|
| 1 | タスク期限管理が属人的で漏れが発生する | Step 2, 3 |
| 2 | 日々のステータス更新量・ポイント消化量が見えない | Step 7 |
| 3 | メンバーへのタスク配分の偏りが見えない | Step 6, 7 |
| 4 | 意図しない遊休状態（手空き）が発生する | Step 6-B（割り振り提案で稼働余力の大きいメンバーに優先アサイン）、Step 2-A（Doingタスクの停滞検出） |

### 1.3 使用技術・サービス

| サービス | 役割 |
|----------|------|
| Notion API | タスクデータベース・メンバー情報の取得・更新 |
| Google スプレッドシート（API） | マスタースケジュール（大項目・小項目・週次SP配分・期限）の取得 |
| GitHub API | 開発タスクの実装進捗（PR・コミット状況）の取得 |
| LLM（Claude API） | 分析・メッセージ生成・返信解釈・提案起案 |
| Slack API | メッセージ送信・返信受信 |
| Cloudflare Workers | 定期実行（cron trigger）・ワークフロー制御 |
| Cloudflare KV / D1 | 前日スナップショット保存（差分検出用） |

---

## 2. データソース定義

### 2.1 Notion タスクデータベース

| プロパティ名 | 型 | 説明 |
|-------------|-----|------|
| タスク名 | Title | 小項目に対応するタスク名 |
| 大項目 | Select | 根拠調査システム / 精度評価システム / 非機能 / 正解データ / ユーザーテスト / UI |
| 小項目 | Select | スプレッドシートの小項目に対応 |
| SP（スプリントポイント） | Number | タスクの工数見積もり |
| 担当者 | People | タスク担当メンバー |
| 実施社 | Select | AICE社 / 貴社 |
| ステータス | Status | Not Started / Todo / Doing / Review / Done |
| 期限 | Date | タスクの完了期限 |
| 開始日 | Date | タスクの開始予定日 |
| GitHub PR | URL | 関連するPull RequestのURL（任意） |

### 2.2 Notion メンバー情報データベース

| プロパティ名 | 型 | 説明 |
|-------------|-----|------|
| メンバー名 | Title | エンジニア名 |
| Slackユーザー ID | Rich Text | Slack メンション用 |
| 今週の稼働可能時間（h） | Number | 他案件・MTG・休暇を除いた実稼働時間。週初にメンバーが申告 or PMが設定 |
| SP換算レート | Number | 1SP あたりの想定時間（h）。デフォルト: 2h。メンバーのスキルや担当領域で調整可 |
| 備考 | Rich Text | 「今週は水曜休み」「他案件で午前のみ稼働」等の補足情報 |

> **運用ルール**: 各メンバーは毎週月曜 9:00 までに「今週の稼働可能時間」を更新する。未更新の場合はデフォルト値（例: 40h）が適用される。

### 2.3 Google スプレッドシート（マスタースケジュール）

スプレッドシートはプロジェクト全体の計画を管理する。

| 列 | 内容 |
|----|------|
| 大項目 | カテゴリ（根拠調査システム等） |
| 小項目 | 具体的なタスク名 |
| 内容 | タスクの詳細説明 |
| 実施社 | AICE社 / 貴社 |
| SP | スプリントポイント合計 |
| 週次列（1/7, 1/14, ...） | 各週に配分されたSP（計画値）。緑背景=実績、青背景=予測 |

### 2.4 GitHub

| 取得データ | 用途 |
|-----------|------|
| PR一覧（Open / Merged / Closed） | 実装タスクの進捗把握 |
| PR のレビューステータス | レビュー待ちボトルネックの検出 |
| 直近のコミット履歴 | 担当者のアクティビティ把握 |

---

## 3. 全体フロー

```
毎朝 9:00（Cloudflare Workers cron trigger）
    │
    ▼
┌─────────────────────────────────────────────┐
│ Step 1: データ収集                            │
│  ・Notion API → タスク一覧取得               │
│  ・Notion API → メンバー情報取得              │
│  ・スプレッドシート API → マスタースケジュール取得│
│  ・GitHub API → PR・コミット状況取得           │
│  ・KV/D1 → 前日スナップショット取得            │
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│ Step 2: LLM分析                              │
│  ・全体タスク状況の分析                        │
│  ・各担当者のタスク状況 × 期限の分析            │
│  ・スプシのスケジュール vs 実績の乖離分析       │
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│ Step 3: 担当者向けメッセージ生成（LLM）        │
│  ・今週（月〜日）期限のタスク一覧表示           │
│  ・残り2日タスク → 「任せても平気？」確認       │
│  ・Doing状態タスク → 進捗ヒアリング            │
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│ Step 4: Slack送信                             │
│  ・指定チャンネルで各担当者にメンション送信      │
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│ Step 5: 担当者返信                            │
│  ・Slackスレッド内で担当者が状況を返信          │
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│ Step 6: LLM返信解釈・分析                     │
│  ・スプシスケジュールのオンスケ判定             │
│  ・残りタスク割り振りの提案起案                 │
│    （稼働可能時間・進捗・状況・残SPを加味）     │
│  ・大項目ごとの完了/リスケ判定・ズレ幅算出      │
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│ Step 7: PMへ送信                              │
│  ・スケジュールオンスケ分析結果                 │
│  ・残りタスク割り振り提案                       │
│  ・大項目ごとのスケジュール分析結果              │
│  ・昨日までの全体タスク状況（差分サマリ）        │
│  ・残り期限2日のタスク状況                      │
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│ Step 8: Notion更新                            │
│  ・PMの返答をLLMが解釈                        │
│  ・Notion APIでタスク更新（担当変更・期限変更等）│
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│ Step 9: 完了通知                              │
│  ・チャンネル全体にNotion更新完了を通知          │
└─────────────────────────────────────────────┘
```

---

## 4. 各ステップ詳細仕様

### Step 1: データ収集

**実行タイミング**: 毎朝 9:00 JST（Cloudflare Workers cron trigger）

**処理内容**:

1. **Notion API**: タスクデータベースから全タスクを取得
   - フィルタ: ステータスが Done 以外
   - 取得項目: タスク名、大項目、SP、担当者、ステータス、期限、開始日
2. **Notion API**: メンバー情報データベースから全メンバーを取得
   - 取得項目: メンバー名、SlackユーザーID、今週の稼働可能時間、SP換算レート、備考
3. **スプレッドシート API**: マスタースケジュールシートを取得
   - 全行の大項目・小項目・SP・週次配分データ
4. **GitHub API**: 対象リポジトリのPR一覧を取得
   - フィルタ: 直近7日間のPR（Open / Merged）
   - 取得項目: PR タイトル、作成者、ステータス、レビュー状況、最終更新日
5. **前日スナップショット取得**: Cloudflare KV/D1 から前日保存したタスク状態JSONを取得
6. **今日のスナップショット保存**: 取得したNotionタスク状態をKV/D1に保存（翌日の差分検出用）

**出力**: 統合タスクデータ（JSON）

---

### Step 2: LLM分析

**入力**: Step 1 の統合タスクデータ

**LLMに実行させる分析**:

#### 2-A. 全体タスク状況分析
- 全タスクのステータス分布（Not Started / Todo / Doing / Review / Done の件数・SP合計）
- 前日からの変化（差分）: ステータス変更されたタスク、完了したSP
- 停滞検出: 過去2日間でステータス変更もGitHubコミットもないDoing タスクをフラグ

#### 2-B. 各担当者のタスク状況分析
- 担当者ごとの今週の担当SP合計・消化済SP・残SP
- 各タスクの「残り日数 vs 残りSP」から間に合うかの判定
- 担当者間のSP偏りの検出

#### 2-C. スプレッドシートスケジュール乖離分析
- スプシの週次計画SP vs Notionの実績SP を大項目ごとに比較
- オンスケ / 遅れ / 前倒し の判定
- 遅れている場合、遅延幅（何日 or 何SP分）を算出

**出力**: 分析結果JSON（各担当者の状況サマリ + 全体サマリ）

---

### Step 3: 担当者向けメッセージ生成

**入力**: Step 2 の分析結果

**メッセージ生成ルール**:

#### 3-A. 今週のタスク一覧（全担当者共通）
現在の週（月曜〜日曜）の間に期限が設定されている全タスクをテーブル形式で表示する。

```
📋 今週のタスク一覧（2/17〜2/23）

| 担当   | チケット内容                | 期限  | SP | ステータス |
|--------|---------------------------|-------|-----|----------|
| 田中   | 正規表現による抽出           | 2/19  | 10  | Doing    |
| 田中   | VLM等によるセクションの調整   | 2/21  | 30  | Todo     |
| 鈴木   | Section単位の評価           | 2/20  | 10  | Doing    |
| 佐藤   | サンプル1-3正解データ作成     | 2/23  | 40  | Doing    |
```

#### 3-B. 残り2日以内のタスク → 確認メッセージ
期限まで残り2日以内のタスクについて、担当者に「このまま任せても平気？」と確認する。

**対象条件**: `期限 - 今日 ≤ 2日` かつ `ステータス ≠ Done`

```
⚠️ @田中
「VLM等によるセクションの調整」の期限が明後日（2/21）です。
残り30ptありますが、このまま任せても大丈夫そうですか？
困っていることがあれば教えてください 🙏
```

#### 3-C. Doing タスク → 進捗ヒアリング
ステータスが Doing のタスクについて進捗を聞く。

**対象条件**: `ステータス = Doing`

```
📝 @鈴木
「Section単位の評価」（期限: 2/20、10pt）は現在 Doing ですが、
今どのくらいまで進んでいますか？
```

#### 3-D. 複合メッセージ（同一担当者に複数該当する場合）
同一担当者に3-B と 3-C の両方が該当する場合、1つのメッセージにまとめる。

```
📋 @田中 今週のタスク状況確認です！

【進捗確認】
・「正規表現による抽出」（期限: 2/19、10pt、Doing）
  → 今どのくらいまで進んでいますか？

【期限間近】
・「VLM等によるセクションの調整」（期限: 2/21、30pt、Todo）
  → 残り2日で30ptですが、このまま任せても大丈夫そうですか？

他にも「正規表現による抽出」が本日期限ですが、
両方並行で進める予定ですか？優先順位があれば教えてください！
```

**LLMプロンプト指針**:
- トーンはフランクだが丁寧（チームの心理的安全性を担保）
- 複数タスクの競合がある場合は必ず言及する
- 質問は具体的にする（「どうですか？」ではなく「何%くらい？」「ブロッカーある？」）

---

### Step 4: Slack送信

**送信先**: 指定されたSlackチャンネル（例: `#pmo-daily`）

**送信形式**:
- 各担当者ごとに1スレッドを作成
- 親メッセージで担当者をメンション
- メッセージはStep 3で生成したテキストをそのまま使用

**Slack API仕様**:
- `chat.postMessage` で親メッセージ送信
- 各担当者ごとにスレッドを分ける（返信を管理しやすくするため）

---

### Step 5: 担当者返信

**待機方法**: Slack Events API（`message` イベント）でスレッド内の返信を検知

**返信待機ルール**:
- 返信待機期間: 当日 18:00 まで
- 未返信の場合: 15:00 に1回リマインド送信
- 18:00 時点で未返信の担当者はPMレポートに「未返信」として記載

**返信データの保存**:
- 担当者名、タスク名、返信テキスト、タイムスタンプをKV/D1に保存
- Step 6 のLLM入力として使用

---

### Step 6: LLM返信解釈・分析

**入力**:
- Step 2 の分析結果
- Step 5 の担当者返信データ
- Step 1 のメンバー情報（稼働可能時間・SP換算レート）

**LLMに実行させる分析**:

#### 6-A. スプシスケジュールのオンスケ判定
担当者の返信内容（「順調」「遅れそう」「ブロッカーあり」等）をStep 2の定量分析と組み合わせ、スプレッドシートの計画に対して各タスクがオンスケかを再判定する。

**出力形式**:
```
【スケジュール判定】
🟢 オンスケ: 12タスク
🟡 注意（1-2日遅延リスク）: 3タスク
🔴 遅延確定: 1タスク
```

#### 6-B. 残りタスク割り振り提案
以下の4要素を加味して、未着手・Todoタスクの割り振りを提案する。

1. **各担当者の進捗**（現在の消化ペース）
2. **担当者の状況**（返信から読み取れる余裕度・ブロッカー有無）
3. **残りSP**（チーム全体の残タスクとSP）
4. **各メンバーの稼働可能時間**（今週の残り稼働時間 − 既アサインタスクの見込み工数）

**稼働可能時間の算出ロジック**:
- Notionのメンバー情報DBに「今週の稼働可能時間（h）」を保持（各メンバーが週初に申告 or PMが設定）
  - 他案件の掛け持ち、MTG、休暇などを考慮した実稼働時間
- 「1SP = 想定Nh」の換算レートを設定（例: 1SP = 2h。チームで調整）
- 稼働余力 = 今週の稼働可能時間 −（既アサインの残りSP × 換算レート）
- 稼働余力がマイナスまたは少ないメンバーには新規タスクを振らない

**出力形式**:
```
【タスク割り振り提案】

[メンバー稼働状況]
| メンバー | 今週稼働可能 | 既アサインSP | 消化済SP | 残SP工数見込み | 稼働余力 |
|---------|------------|------------|---------|-------------|---------|
| 田中    | 35h        | 40pt       | 30pt    | 20h (10pt)  | 15h     |
| 鈴木    | 20h（他案件あり）| 15pt  | 10pt    | 10h (5pt)   | 10h     |
| 佐藤    | 40h        | 50pt       | 45pt    | 10h (5pt)   | 30h     |

[割り振り提案]
・「ラベル付与して結果の可視化」（10pt ≒ 20h）→ 佐藤
  （理由: 稼働余力30hで最も余裕あり。現タスク完了見込みが早い）
・「エッジ系・異常系データの作成」（30pt ≒ 60h）→ 田中・佐藤で分担を推奨
  （理由: 単独では1週間で消化困難。田中15h+佐藤残10hで今週着手、来週完了目標）
・鈴木は他案件掛け持ちのため今週の追加アサイン非推奨
```

#### 6-C. 大項目ごとのスケジュール分析
スプレッドシートの大項目（根拠調査システム、精度評価システム等）ごとに、完了見込みを分析する。

**出力形式**:
```
【大項目別スケジュール分析】

■ 根拠調査システム（計画: 2/28完了）
  計画SP: 100pt / 消化済: 65pt / 残: 35pt
  判定: 🟢 オンスケ（現ペースで2/26完了見込み）

■ 精度評価システム（計画: 3/7完了）
  計画SP: 95pt / 消化済: 40pt / 残: 55pt
  判定: 🔴 リスケ推奨
  遅延見込み: 約5日（3/12完了見込み）
  ボトルネック:「Web上の公的情報調査の評価」（30pt、未着手）

■ 非機能（計画: 3/14完了）
  計画SP: 150pt / 消化済: 0pt / 残: 150pt
  判定: 🟡 注意（未着手。来週開始しないと遅延リスク）
```

---

### Step 7: PMへ送信

**送信先**: PM専用チャンネル or PM個人DM

**送信タイミング**: Step 6 完了後（目安: 当日18:00〜19:00）

**メッセージ構成**:

```
━━━━━━━━━━━━━━━━━━━━━━━━━
📊 PMOデイリーレポート（2/19）
━━━━━━━━━━━━━━━━━━━━━━━━━

【1. スケジュールオンスケ分析】
（Step 6-A の結果）

【2. タスク割り振り提案】
（Step 6-B の結果）
→ 承認 / 修正の返信をお願いします

【3. 大項目別スケジュール分析】
（Step 6-C の結果）

【4. 昨日までの全体タスク状況】
  完了SP: 120pt → 135pt（+15pt）
  ステータス変更: 5件
  ・「正規表現による抽出」: Doing → Done（+10pt）
  ・「LLMによる抽出」: Todo → Doing
  ・...

【5. 残り期限2日のタスク状況】
| 担当 | タスク | 期限 | 残SP | 担当者コメント |
|------|--------|------|------|--------------|
| 田中 | VLM調整 | 2/21 | 30 | 「7割完了、間に合う見込み」 |
| 鈴木 | Section評価 | 2/20 | 10 | 未返信 ⚠️ |
━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

### Step 8: Notion更新

**トリガー**: PMがSlackで返信

**処理フロー**:

1. PMの返信をLLMが解釈
2. 解釈結果から実行するNotion更新アクションを決定
3. 実行前にPMに確認メッセージを送信
4. PM が ✅ リアクション後、Notion API で更新を実行

**対応する更新アクション**:

| PMの返信例 | Notion更新アクション |
|-----------|---------------------|
| 「タスクXを田中→鈴木に変更」 | 担当者プロパティの変更 |
| 「タスクXの期限を3/1に延長」 | 期限プロパティの変更 |
| 「タスクXのSPを15→20に変更」 | SPプロパティの変更 |
| 「割り振り提案を承認」 | 提案内容に基づき一括更新 |
| 「タスクXを追加」 | 新規ページ作成 |

**安全策**:
- LLMが解釈した更新内容を実行前にPMに確認メッセージを送信
- 「以下の更新を実行します。問題なければ ✅ をリアクションしてください」
- ✅ リアクション検知後に Notion API を実行

---

### Step 9: 完了通知

**トリガー**: Step 8 のNotion更新完了

**送信先**: 指定チャンネル（`#pmo-daily` 等）

**メッセージ**:

```
✅ Notion更新完了（2/19 19:30）

更新内容:
・「VLM等によるセクションの調整」担当: 田中 → 鈴木に変更
・「Section単位の評価」期限: 2/20 → 2/23に延長
・「ラベル付与して結果の可視化」担当: 田中にアサイン

最新のタスクボードはこちら → [Notionリンク]
```

---

## 5. LLMプロンプト設計方針

### 5.1 共通指針
- 分析は定量データ（SP、日数、件数）を必ず根拠として含める
- 主観的な判断（「遅れそう」等）には必ず数値的根拠を付与する
- 担当者向けメッセージはフランクだが丁寧なトーン
- PM向けレポートは簡潔・構造化された形式

### 5.2 各ステップのプロンプト構成

| ステップ | システムプロンプトに含める内容 |
|---------|---------------------------|
| Step 2 | 分析観点の定義、判定基準（🟢🟡🔴の閾値）、出力JSON形式 |
| Step 3 | メッセージテンプレート、トーン指定、対象タスクの選定条件 |
| Step 6 | 返信の解釈ルール、提案のフォーマット、リスケ判定基準、稼働可能時間の考慮ルール |
| Step 8 | Notion更新アクションの種類、PMの返信パターン定義 |

### 5.3 判定基準

| 判定 | 条件 |
|------|------|
| 🟢 オンスケ | `残りSP ÷ 残り日数 ≤ 過去7日の平均日次消化SP` |
| 🟡 注意 | `残りSP ÷ 残り日数 > 平均日次消化SP × 1.2` |
| 🔴 危険 | `残りSP ÷ 残り日数 > 平均日次消化SP × 1.5` または `期限まで2日以内 かつ 残SP > 日次消化SP × 2` |

---

## 6. 非機能要件

### 6.1 実行スケジュール

| 時刻 | 処理 |
|------|------|
| 09:00 | Step 1〜4 実行（データ収集→分析→メッセージ生成→Slack送信） |
| 15:00 | 未返信者へリマインド送信 |
| 18:00 | 返信締切 → Step 6〜7 実行（分析→PMレポート送信） |
| PMの返信後 | Step 8〜9 実行（Notion更新→完了通知） |

### 6.2 エラーハンドリング

| エラー | 対応 |
|--------|------|
| Notion API 取得失敗 | 3回リトライ後、PMにエラー通知 |
| スプレッドシート API 取得失敗 | 3回リトライ後、Notion データのみで分析を実行 |
| GitHub API 取得失敗 | 3回リトライ後、GitHub データなしで分析を実行 |
| LLM API エラー | 3回リトライ後、PMにエラー通知（生データを添付） |
| Slack送信失敗 | 3回リトライ後、PM にエラー通知 |
| PM未返信（Step 8待ち） | 翌朝のcron実行時に前日未処理としてリマインド |

### 6.3 セキュリティ
- API キーは Cloudflare Workers の環境変数（Secrets）に保存
- Notion / GitHub のアクセス範囲は必要最小限のスコープに限定
- Slack Bot のチャンネル参加は対象チャンネルのみに制限

---

## 7. 今後の拡張候補（スコープ外）

| 拡張案 | 概要 |
|--------|------|
| Slack対話型クエリ | PMが「@PMObot 根拠調査の進捗は？」と聞くとリアルタイムで回答 |
| スプレッドシート自動更新 | Notion実績をスプシの実績セル（緑背景）に自動反映 |
| 週次レトロスペクティブ | 週末にSP消化率・見積もり精度のレポートを自動生成 |
| ベロシティ予測 | 過去のスプリント実績からチームのベロシティを算出し、将来スプリントの予測に活用 |
